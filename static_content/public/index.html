<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8" /> 
	<title>Memuy</title>
	<style>
	#file-container {
		background: #ccc;
		min-height: 300px;
	}

	#template-container {
		display: none;
	}

	#msg {
		display: none;
	}

	#files .file {
		border-bottom: 1px solid #000;
		padding: 20px;
	}
	</style>
</head>
<body>
	<h1>Memuy</h1>
	<p>
		<!--
		<b>Como funciona:</b> Ao entrar no Memuy pela primeira vez você é colocado em uma sala aleatória, a partir deste momento você pode arrastar arquivos para a área indicada abaixo e todas as pessoas que estiverem com a sala aberta os receberão em tempo real! Para compartilhar uma sala basta enviar a URL ou então somente o nome da sala para ser informado no campo abaixo. :)
		<br/>
		Você pode testar usando duas janelas no seu browser!
		-->

		<b>How it works:</b> Once Memuy is open, the user (you, in this case) will be placed in a new room. From this moment on he can drag files making them available to everyone else on the room. Besides that, the room can be shared by sending the room's name or the room's URL to whoever he wants to. The user can also use rooms to share files between his devices: from his cellphone to his laptop, for example.
		<br/>
		You can test it using multiple windows on your browser!
	</p>

	<h2>Room: <span id="roomName"></span></h2>
	<a href="#" class="gotoNewRoom">Go to new room</a>

	<br/>

	<div id="qrcode"></div>

	<div id="msg"></div>

	<br/>

	<form action="">
		<label>Go to :</label>
    	<input id="m" autocomplete="off" /><button>Send</button>
    </form>

    <br/>

    Drag the file or click in the button
    <button class="send-file">Send file</button>

    <div id="file-container">
		<div id="files" class="dropzone-previews">
		</div>
	</div>

	<div id="template-container">
		<div class="file">
			<a href="#" target="_blank" class="file-link" data-dz-name></a> <span data-dz-size></span> <span class="file-progress"></span>
		</div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="/public/assets/js/dropzone.js"></script>
	<script src="/public/assets/js/qrcode.min.js"></script>

	<script>
	var rand = function() {
    	return Math.random().toString(36).substr(2);
	};

	var token = function() {
	    return rand() + rand();
	};


	var socket = io(),
		currentRoom = null,
		roomOnPath,
		identifier = token(),
		qrcodeObj = null

	generateQRCode = function(room) {
		if (qrcodeObj == null) {
			qrcodeObj = new QRCode(document.getElementById("qrcode"), {
			    text: room,
			    width: 128,
			    height: 128,
			    colorDark : "#000000",
			    colorLight : "#ffffff",
			    correctLevel : QRCode.CorrectLevel.H
			})
		} else {
			qrcodeObj.makeCode(room)
		}
	}

	tryRoom = function(room, type) {
		socket.emit('tryRoom', room, {type: type})
	}

	adjustPreviewAfterSave = function(element, fileObj) {
		var fileElement = $(element),
			link = '/public/uploads/' + fileObj.name

		//console.log(fileElement.innerHTML);
		fileElement.find('.file-link').attr('href', link)
	}

	addFile = function(fileObj) {
		var mockFile = {name: fileObj.originalName, size: fileObj.size}
		myDropzone.emit("addedfile", mockFile);
		myDropzone.emit("complete", mockFile);

		adjustPreviewAfterSave(mockFile.previewElement, fileObj)
	}

	roomOnPath = window.location.pathname.replace('/', '')

	if (roomOnPath == '') {
		socket.emit('newRoom')
	} else {
		tryRoom(roomOnPath, 'url')
	}

	socket.on('roomData', function(roomObj) {
		var roomName = roomObj.room
		currentRoom = roomName
	    $('#roomName').text(roomName)
	    generateQRCode(roomName)

	    window.history.pushState({}, 'Memuy', '/' + roomName);

	    roomObj.files.forEach(function(file) {
			addFile(file)
	    })
	});	

	socket.on('newFile', function(res) {
		if (res.identifier != identifier) {
			addFile(res.file)
		}
	})

	socket.on('roomError', function(errorCode) {
		var msg

		if (errorCode == 4041) {
			//msg = 'Foi mal! Não estou encontrando esta sala. Por questões de segurança não é possível personalizar o nome de uma sala. Clique <a href="#" class="gotoNewRoom">aqui</a> para entrar em uma nova sala.'
			msg = 'Sorry! I cannot find this room and for security reasons it\'s not possible to personalize the name of the rooms. Click <a href="#" class="gotoNewRoom">here</a> to go to a new random room.';
		} else if (errorCode == 4042) {
			//msg = 'Foi mal! Não encontrei esta sala.'
			msg = 'Sorry! I cannot find this room. :('
		}

		$('#msg').html(msg).show()
	})

	$('body').on('click', '.gotoNewRoom', function () {
        window.location.href = "/";
    });

	$('form').submit(function(){
		var newRoom = $('#m').val()
		if (currentRoom == newRoom) {
			return false
		}
		tryRoom(newRoom, 'form')
		$('#m').val('')
		return false
	});

	var myDropzone = new Dropzone("div#file-container", {
		method: 'post', 
		url: "/files",
		maxFilesize: 5000,
		previewsContainer: ".dropzone-previews",
		previewTemplate: document.querySelector('#template-container').innerHTML,
		clickable: '.send-file',
		sending: function(file, xhr, formData) {
			formData.append('roomName', currentRoom)
			formData.append('identifier', identifier)
		},
		success: function(file, res) {
			$(file.previewElement).attr('id', 'file-' + res.file._id)
			adjustPreviewAfterSave(file.previewElement, res.file)
		},
		uploadprogress: function(file, progress, bytesSent) {
			$(file.previewElement).find('.file-progress').html(progress)
		}
	});
	</script>
</body>
</html>